# Azure DevOps CI/CD Pipeline for ProjectX Order Management System
# Demo Version - Works without Azure Resources

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

variables:
  buildConfiguration: "Release"
  nodeVersion: "18.x"

pool:
  name: "Default"
  # Use 'Default' pool for self-hosted agent
  # Change to 'vmImage: ubuntu-latest' when Microsoft-hosted parallelism is available

stages:
  # ==========================================
  # Stage 1: Build and Test
  # ==========================================
  - stage: Build
    displayName: "Build and Test"
    jobs:
      - job: BuildJob
        displayName: "Build Application"
        steps:
          - checkout: self
            displayName: "Checkout Code"

          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: $(nodeVersion)

          - script: |
              cd app
              npm install
            displayName: "Install Dependencies"

          - script: |
              cd app
              npm test
            displayName: "Run Tests"
            continueOnError: true

          - script: |
              cd app
              npm run build --if-present
            displayName: "Build Application"

          - task: ArchiveFiles@2
            displayName: "Archive Application"
            inputs:
              rootFolderOrFile: "$(System.DefaultWorkingDirectory)/app"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
              replaceExistingArchive: true

          - publish: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip"
            artifact: drop
            displayName: "Publish Artifact"

  # ==========================================
  # Stage 2: Deploy to Staging (Simulated)
  # ==========================================
  - stage: DeployStaging
    displayName: "Deploy to Staging (Demo)"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployStagingJob
        displayName: "Staging Deployment"
        environment: "ProjectX-Staging"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                  displayName: "Download Build Artifact"

                - script: |
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "  Staging Deployment (Demo Mode)"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "âœ“ Application package downloaded"
                    echo "âœ“ Health checks passed (simulated)"
                    echo "âœ“ Staging environment ready (simulated)"
                    echo ""
                    echo "In production, this would deploy to:"
                    echo "  URL: https://projectx-staging.azurewebsites.net"
                    echo ""
                    echo "Deployment Status: SUCCESS (Demo)"
                  displayName: "Simulate Staging Deployment"

                - script: |
                    echo "Running smoke tests..."
                    echo "âœ“ Application health check: OK"
                    echo "âœ“ API endpoints responding: OK"
                    echo "âœ“ Database connection: OK (simulated)"
                  displayName: "Run Smoke Tests"

  # ==========================================
  # Stage 3: Deploy to Production (Simulated)
  # ==========================================
  - stage: DeployProduction
    displayName: "Deploy to Production (Demo)"
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - deployment: DeployProductionJob
        displayName: "Production Deployment"
        environment: "ProjectX-Production"
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                  displayName: "Download Build Artifact"

                - script: |
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo "  Production Deployment (Demo Mode)"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "âœ“ Application package downloaded"
                    echo "âœ“ Pre-deployment validation passed"
                    echo "âœ“ Production environment ready (simulated)"
                    echo ""
                    echo "In production, this would deploy to:"
                    echo "  URL: https://projectx-production.azurewebsites.net"
                    echo ""
                    echo "Deployment Status: SUCCESS (Demo)"
                  displayName: "Simulate Production Deployment"

                - script: |
                    echo "Running production validation..."
                    echo "âœ“ Application health check: OK"
                    echo "âœ“ All API endpoints: OK"
                    echo "âœ“ Performance metrics: Within limits"
                    echo "âœ“ Security scan: Passed"
                    echo ""
                    echo "ğŸ‰ Deployment completed successfully!"
                  displayName: "Run Production Validation"
